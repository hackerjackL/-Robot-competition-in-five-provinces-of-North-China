# 华北五省机器人大赛 - 巡线机器人项目

项目参考：https://blog.csdn.net/m0_62930060/article/details/143892364?spm=1001.2014.3001.5501

## 项目简介

本项目包含2024和2025两个版本的巡线机器人代码，实现了基于视觉的巡线功能，支持可配置的面积过滤算法。
2024版本时树莓派4b黄色界面，如果是蓝色界面，用5b，2025版本是树莓派5b，蓝色界面，但如果用的2025版本的5b系统，则两套代码都用不了。

## 项目结构

```
-Robot-competition-in-five-provinces-of-North-China/
├── 2024巡线.py                    # 2024版本原始巡线代码
├── 2025巡线.py                    # 2025版本原始巡线代码
├── 2024巡线_面积过滤.py           # 2024版本带可配置面积过滤的巡线代码
├── 2025巡线_面积过滤.py           # 2025版本带可配置面积过滤的巡线代码
├── area_test/                     # 面积测试工具目录
│   ├── 2024_area_test_detection.py    # 2024版本面积检测脚本
│   ├── 2024_area_test_statistics.py   # 2024版本面积统计脚本
│   ├── 2025_area_test_detection.py    # 2025版本面积检测脚本
│   └── 2025_area_test_statistics.py   # 2025版本面积统计脚本
└── README.md                      # 项目说明文档
```

## 文件说明

### 1. 2024巡线.py (371行)

**功能：** 2024版本原始巡线代码

**关键代码位置：**
- 面积过滤逻辑：第241-251行
  - 第242行：硬编码面积过滤 `0 < cv2.contourArea(cnt) <= 100`
  - 第243-251行：轮廓选择策略（多轮廓选最大，单轮廓直接使用）

**特点：**
- 使用 `hiwonder.Board` 控制硬件
- q值（偏差值）：50（第217行）
- 面积过滤上限：100（硬编码）

---

### 2. 2025巡线.py (370行)

**功能：** 2025版本原始巡线代码

**关键代码位置：**
- 面积过滤逻辑：第243-253行
  - 第244行：硬编码面积过滤 `0 < cv2.contourArea(cnt) <= 100`
  - 第245-253行：轮廓选择策略（多轮廓选最大，单轮廓直接使用）

**特点：**
- 使用 `hiwonder.ros_robot_controller_sdk` 和 `Controller` 控制硬件
- q值（偏差值）：70（第219行）
- 面积过滤上限：100（硬编码）

**与2024版本的主要区别：**
- 硬件控制API不同（第33-34行）
- q值从50增加到70
- 注释更准确（第119行注释为"大于100"而非"大于300"）

---

### 3. 2024巡线_面积过滤.py (374行)

**功能：** 2024版本带可配置面积过滤的巡线代码

**关键代码位置：**
- **面积过滤配置：** 第45-47行
  ```python
  min_area = 1      # 最小面积阈值，用于过滤噪声
  max_area = 100    # 最大面积阈值，用于过滤大面积干扰
  ```

- **面积过滤逻辑：** 第244-254行
  - 第246行：统一应用面积范围过滤 `min_area <= cv2.contourArea(cnt) <= max_area`
  - 第248-254行：统一处理逻辑（移除单轮廓特殊处理）

**改进点：**
- ✅ 可配置的面积阈值（min_area, max_area）
- ✅ 统一的面积过滤逻辑（所有轮廓都应用相同检查）
- ✅ 移除了单轮廓时的特殊处理，逻辑更严格

---

### 4. 2025巡线_面积过滤.py (373行)

**功能：** 2025版本带可配置面积过滤的巡线代码

**关键代码位置：**
- **面积过滤配置：** 第49-51行
  ```python
  min_area = 1      # 最小面积阈值，用于过滤噪声
  max_area = 100    # 最大面积阈值，用于过滤大面积干扰
  ```

- **面积过滤逻辑：** 第246-256行
  - 第248行：统一应用面积范围过滤 `min_area <= cv2.contourArea(cnt) <= max_area`
  - 第250-256行：统一处理逻辑（移除单轮廓特殊处理）

**改进点：**
- ✅ 可配置的面积阈值（min_area, max_area）
- ✅ 统一的面积过滤逻辑（所有轮廓都应用相同检查）
- ✅ 移除了单轮廓时的特殊处理，逻辑更严格

---

## 面积过滤算法说明

### 原始算法（2024巡线.py / 2025巡线.py）

**问题：**
1. 硬编码面积上限为100
2. 逻辑不一致：单轮廓时跳过面积检查
3. 无法根据实际场景调整阈值

**算法流程：**
```
1. 过滤轮廓：0 < 面积 <= 100
2. 如果存在多个有效轮廓 → 选择面积最大的
3. 如果只有一个轮廓（无论面积） → 直接使用（跳过检查）
4. 如果没有轮廓 → 返回None
```

### 改进算法（2024巡线_面积过滤.py / 2025巡线_面积过滤.py）

**优势：**
1. ✅ 可配置的面积范围 [min_area, max_area]
2. ✅ 统一的过滤逻辑，所有轮廓都应用相同检查
3. ✅ 更严格的过滤，无例外情况

**算法流程：**
```
1. 过滤轮廓：min_area <= 面积 <= max_area
2. 如果存在有效轮廓 → 选择面积最大的
3. 如果没有有效轮廓 → 返回None
```

**配置参数：**
- `min_area`：最小面积阈值，默认1，用于过滤噪声
- `max_area`：最大面积阈值，默认100，用于过滤大面积干扰

---

## 面积测试工具

### area_test/ 目录说明

该目录包含用于测试和统计面积数据的工具脚本。

#### 1. 2024_area_test_detection.py (220行)

**功能：** 基于2024巡线.py的面积检测测试脚本

**关键功能：**
- 第68-133行：`detect_max_area()` 函数 - 检测每个ROI区域的最大面积
- 第135-150行：`save_area_data()` 函数 - 将检测结果保存为JSON文件
- 第152-218行：主程序 - 实时检测并保存面积数据

**使用方式：**
- 按 `s` 键：手动保存当前帧的面积数据
- 按 `q` 键：退出程序
- 自动保存：每30帧自动保存一次

**输出文件：** `area_test/area_data_YYYYMMDD_HHMMSS_mmm.json`

---

#### 2. 2024_area_test_statistics.py (148行)

**功能：** 统计2024版本面积数据的最小值和最大值

**关键功能：**
- 第12-28行：`load_all_area_data()` - 加载所有面积数据JSON文件
- 第30-74行：`calculate_statistics()` - 计算统计信息
- 第76-102行：`print_statistics()` - 打印统计结果
- 第104-124行：`save_statistics()` - 保存统计结果

**输出：**
- 控制台：打印详细统计信息
- 文件：`area_test/area_statistics.json`

---

#### 3. 2025_area_test_detection.py (220行)

**功能：** 基于2025巡线.py的面积检测测试脚本

**关键功能：**
- 与2024版本相同，但基于2025巡线.py的图像处理逻辑
- 输出文件前缀：`2025_area_data_`

---

#### 4. 2025_area_test_statistics.py (149行)

**功能：** 统计2025版本面积数据的最小值和最大值

**关键功能：**
- 与2024版本相同，但只读取 `2025_area_data_` 前缀的文件
- 输出文件：`area_test/2025_area_statistics.json`

---

## 使用指南

### 1. 调整面积过滤阈值

编辑 `2024巡线_面积过滤.py` 或 `2025巡线_面积过滤.py` 文件：

```python
# 第45-47行（2024版本）或第49-51行（2025版本）
min_area = 1      # 根据实际测试结果调整最小值
max_area = 100    # 根据实际测试结果调整最大值
```

### 2. 运行面积测试

**步骤1：** 运行检测脚本收集数据
```bash
python3 area_test/2024_area_test_detection.py
# 或
python3 area_test/2025_area_test_detection.py
```

**步骤2：** 运行统计脚本分析数据
```bash
python3 area_test/2024_area_test_statistics.py
# 或
python3 area_test/2025_area_test_statistics.py
```

**步骤3：** 根据统计结果调整阈值
- 查看统计结果中的最小值和最大值
- 根据实际巡线效果调整 `min_area` 和 `max_area`

---

## 版本差异总结

| 特性 | 2024版本 | 2025版本 |
|------|---------|---------|
| 硬件控制 | `hiwonder.Board` | `rrc.Board()` + `Controller` |
| q值（偏差值） | 50 | 70 |
| 面积过滤上限 | 100（硬编码） | 100（硬编码） |
| 面积过滤改进版 | ✅ 可配置 | ✅ 可配置 |

---

## 技术要点

1. **ROI区域分割：** 将图像分为上中下三个区域，权重分别为0.1、0.3、0.6
2. **颜色空间转换：** 使用LAB颜色空间进行颜色检测
3. **形态学处理：** 腐蚀+膨胀操作去除噪声
4. **面积过滤：** 可配置的范围过滤，统一处理所有轮廓
5. **轮廓选择：** 在有效轮廓中选择面积最大的

---

## 注意事项

1. 所有代码需要在树莓派环境下运行（依赖hiwonder库）
2. 运行前需要配置相机校准参数
3. 面积阈值需要根据实际场景和测试结果进行调整
4. 建议先使用测试工具收集数据，再根据统计结果调整阈值

---

## 更新日志



2024版本时树莓派4b黄色界面，如果是蓝色界面，用5b，2025版本是树莓派5b，蓝色界面，但如果用的2025版本的5b系统，则两套代码都用不了！！！！
